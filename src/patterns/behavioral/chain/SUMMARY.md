# Node.js ä¸­é—´ä»¶è®¾è®¡æ¨¡å¼æ€»ç»“

## ğŸ¯ é—®é¢˜å›ç­”

### Node.js ä¸­é—´ä»¶æ˜¯ä»€ä¹ˆè®¾è®¡æ¨¡å¼ï¼Ÿ

**ç­”æ¡ˆï¼šè´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility Pattern)**

## ğŸ“Š æ ¸å¿ƒç‰¹å¾å¯¹æ¯”

| ç‰¹å¾         | è´£ä»»é“¾æ¨¡å¼ | Node.js ä¸­é—´ä»¶        |
| ------------ | ---------- | --------------------- |
| **é“¾å¼ä¼ é€’** | âœ…         | âœ… `next()`           |
| **å¯ä¸­æ–­**   | âœ…         | âœ… ä¸è°ƒç”¨ `next()`    |
| **é¡ºåºæ‰§è¡Œ** | âœ…         | âœ… æŒ‰æ³¨å†Œé¡ºåº         |
| **ç‹¬ç«‹å¤„ç†** | âœ…         | âœ… æ¯ä¸ªä¸­é—´ä»¶ç‹¬ç«‹     |
| **è§£è€¦**     | âœ…         | âœ… å‘é€è€…ä¸æ¥æ”¶è€…è§£è€¦ |

## ğŸ” è®¾è®¡æ¨¡å¼åˆ†æ

### ä¸»è¦æ¨¡å¼ï¼šè´£ä»»é“¾æ¨¡å¼

```typescript
// ä¸­é—´ä»¶é“¾
app.use(middleware1)  // èŠ‚ç‚¹1
app.use(middleware2)  // èŠ‚ç‚¹2
app.use(middleware3)  // èŠ‚ç‚¹3

// æ‰§è¡Œæµç¨‹
middleware1 â†’ next() â†’ middleware2 â†’ next() â†’ middleware3
```

### æ¬¡è¦æ¨¡å¼

1. **ç®¡é“æ¨¡å¼ (Pipeline)**ï¼šæ•°æ®æµè§†è§’
   - è¯·æ±‚åƒæ°´æµä¸€æ ·é€šè¿‡ç®¡é“
   - æ¯ä¸ªä¸­é—´ä»¶è½¬æ¢/è¿‡æ»¤æ•°æ®

2. **è£…é¥°å™¨æ¨¡å¼ (Decorator)**ï¼šåŠŸèƒ½å¢å¼ºè§†è§’
   - ä¸º req/res æ·»åŠ æ–°åŠŸèƒ½
   - ä¸ä¿®æ”¹åŸå§‹å¯¹è±¡

## ğŸ’¡ ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ

### âœ… ä¼˜åŠ¿

1. **çµæ´»æ€§**

   ```javascript
   // å¯ä»¥è‡ªç”±ç»„åˆä¸­é—´ä»¶
   app.use(cors())
   app.use(helmet())
   app.use(bodyParser())
   ```

2. **å¯ç»´æŠ¤æ€§**

   ```javascript
   // æ¯ä¸ªä¸­é—´ä»¶èŒè´£å•ä¸€
   const logger = (req, res, next) => {
     /* åªè´Ÿè´£æ—¥å¿— */
   }
   const auth = (req, res, next) => {
     /* åªè´Ÿè´£è®¤è¯ */
   }
   ```

3. **å¯æ‰©å±•æ€§**

   ```javascript
   // å®¹æ˜“æ·»åŠ æ–°åŠŸèƒ½
   app.use(newMiddleware) // é›¶ä¾µå…¥
   ```

4. **å¯å¤ç”¨æ€§**
   ```javascript
   // ä¸­é—´ä»¶å¯ä»¥å¤ç”¨
   app.get('/api/users', auth, validator, controller)
   app.post('/api/users', auth, validator, controller)
   ```

## ğŸŒŸ å®é™…æ¡†æ¶å¯¹æ¯”

### 1. Express.js - ç»å…¸è´£ä»»é“¾

```javascript
app.use(logger) // 1. æ—¥å¿—
app.use(auth) // 2. è®¤è¯
app.use(handler) // 3. ä¸šåŠ¡
```

**ç‰¹ç‚¹**ï¼šçº¿æ€§é“¾ã€å¯ä¸­æ–­

### 2. Koa.js - æ´‹è‘±æ¨¡å‹ï¼ˆå¢å¼ºç‰ˆï¼‰

```javascript
app.use(async (ctx, next) => {
  console.log('è¿›å…¥') // 1
  await next() // ç­‰å¾…åç»­ä¸­é—´ä»¶
  console.log('è¿”å›') // 4
})

app.use(async (ctx, next) => {
  console.log('å¤„ç†') // 2
  ctx.body = 'Done' // 3
})
```

**ç‰¹ç‚¹**ï¼šåŒå‘é“¾ã€æ´‹è‘±æ¨¡å‹

### 3. NestJS - è£…é¥°å™¨ + è´£ä»»é“¾

```typescript
@Injectable()
export class LoggerMiddleware {
  use(req, res, next) {
    console.log('Request...')
    next()
  }
}
```

**ç‰¹ç‚¹**ï¼šé¢å‘å¯¹è±¡ã€è£…é¥°å™¨å¢å¼º

## ğŸ“ ç¤ºä¾‹ä»£ç 

æˆ‘ä»¬æä¾›äº†å®Œæ•´çš„ç¤ºä¾‹ä»£ç ï¼š

### 1. åŸºç¡€è´£ä»»é“¾å®ç°

- æ–‡ä»¶ï¼š`UltraMinimalChain.ts`
- å†…å®¹ï¼šæ ¸å¿ƒ Handler ç±» + åŸºç¡€ç¤ºä¾‹

### 2. Node.js ä¸­é—´ä»¶æ¨¡æ‹Ÿ

- æ–‡ä»¶ï¼š`examples/SimpleExpressMiddleware.ts`
- å†…å®¹ï¼šç®€åŒ–ç‰ˆ Express ä¸­é—´ä»¶ç³»ç»Ÿ
- æ¼”ç¤ºï¼š
  - âœ… æ—¥å¿—ä¸­é—´ä»¶
  - âœ… è®¤è¯ä¸­é—´ä»¶
  - âœ… æƒé™ä¸­é—´ä»¶
  - âœ… éªŒè¯ä¸­é—´ä»¶
  - âœ… ä¸šåŠ¡å¤„ç†ä¸­é—´ä»¶

### 3. å…¶ä»–åº”ç”¨åœºæ™¯

- å®¡æ‰¹æµç¨‹ï¼š`examples/ApprovalChain.ts`
- è¡¨å•éªŒè¯ï¼š`examples/ValidationChain.ts`
- HTTP ä¸­é—´ä»¶ï¼š`examples/MiddlewareChain.ts`

## ğŸš€ å¿«é€Ÿä½“éªŒ

```bash
# 1. è¿è¡ŒåŸºç¡€ç¤ºä¾‹
npx tsx src/patterns/behavioral/chain/UltraMinimalChain.ts

# 2. è¿è¡Œ Node.js ä¸­é—´ä»¶æ¼”ç¤ºï¼ˆæ¨èï¼‰
npx tsx src/patterns/behavioral/chain/examples/SimpleExpressMiddleware.ts

# 3. è¿è¡Œæ‰€æœ‰ç¤ºä¾‹
npx tsx src/patterns/behavioral/chain/examples/index.ts
```

## ğŸ“š å­¦ä¹ è·¯å¾„

1. **ç†è§£æ ¸å¿ƒæ¦‚å¿µ**
   - é˜…è¯»ï¼š`UltraMinimalChain.ts`ï¼ˆå‰ 75 è¡Œï¼‰
   - ç†è§£ï¼šHandler ç±»çš„å®ç°

2. **æŸ¥çœ‹å®é™…åº”ç”¨**
   - é˜…è¯»ï¼š`NodejsMiddleware.md`
   - è¿è¡Œï¼š`SimpleExpressMiddleware.ts`

3. **åŠ¨æ‰‹å®è·µ**
   - ä¿®æ”¹ç¤ºä¾‹ä»£ç 
   - æ·»åŠ è‡ªå·±çš„ä¸­é—´ä»¶
   - åœ¨é¡¹ç›®ä¸­åº”ç”¨

## ğŸ“ å…³é”®è¦ç‚¹

### è´£ä»»é“¾æ¨¡å¼çš„æœ¬è´¨

1. **é“¾å¼ä¼ é€’**ï¼šæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¼ é€’ç»™ä¸‹ä¸€ä¸ª
2. **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªèŠ‚ç‚¹èŒè´£å•ä¸€
3. **å¯ä¸­æ–­æ€§**ï¼šä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥ç»ˆæ­¢é“¾
4. **åŠ¨æ€ç»„åˆ**ï¼šå¯ä»¥è‡ªç”±å¢åˆ èŠ‚ç‚¹

### Node.js ä¸­é—´ä»¶çš„å®ç°

1. **`next()` å‡½æ•°**ï¼šè´£ä»»é“¾çš„æ ¸å¿ƒæœºåˆ¶
2. **ä¸­é—´ä»¶æ•°ç»„**ï¼šå­˜å‚¨æ‰€æœ‰èŠ‚ç‚¹
3. **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰æ³¨å†Œé¡ºåºè°ƒç”¨
4. **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼š`req`ã€`res` å¯¹è±¡è´¯ç©¿å…¨é“¾

## ğŸ”— ç›¸å…³èµ„æº

- [è´£ä»»é“¾æ¨¡å¼ README](./README.md)
- [Node.js ä¸­é—´ä»¶è¯¦è§£](./NodejsMiddleware.md)
- [Express å®˜æ–¹æ–‡æ¡£](https://expressjs.com/en/guide/using-middleware.html)
- [Koa å®˜æ–¹æ–‡æ¡£](https://koajs.com/)

## âœ¨ æ€»ç»“

**Node.js ä¸­é—´ä»¶ = è´£ä»»é“¾æ¨¡å¼çš„å®Œç¾å®è·µ**

- âœ… æ ¸å¿ƒæ˜¯è´£ä»»é“¾æ¨¡å¼
- âœ… èåˆäº†ç®¡é“æ¨¡å¼æ€æƒ³
- âœ… ä½“ç°äº†è£…é¥°å™¨æ¨¡å¼
- âœ… æ˜¯è®¾è®¡æ¨¡å¼åœ¨å®é™…å¼€å‘ä¸­çš„ç»å…¸åº”ç”¨

é€šè¿‡å­¦ä¹  Node.js ä¸­é—´ä»¶ï¼Œä½ å¯ä»¥æ·±å…¥ç†è§£è´£ä»»é“¾æ¨¡å¼å¦‚ä½•åœ¨çœŸå®é¡¹ç›®ä¸­å‘æŒ¥ä½œç”¨ï¼
